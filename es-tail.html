<script type="text/javascript">
(function() {
    
    function activateAjaxCall(node, active, successCallback) {
        $.ajax({
            url: "es-tail/"+node.id+"/"+(active?"enable":"disable"),
            type: "POST",
            data: null,
            success: successCallback,
            error: function(jqXHR,textStatus,errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.not-deployed")}),"error");
                } else if (jqXHR.status === 0) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.no-response")}),"error");
                } else {
                    // TODO where is the err.status comming from?
                    RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:err.status,message:err.response})}),"error");
                }
            }
        });
    }
    
    RED.nodes.registerType('es-tail',{
        category: 'Elasticsearch',
        defaults: {
          name: {value: ''},
          index: {value: ''},
          timeField: {value: '@timestamp'},
          interval: {value: 180 },
          lookback: {value: 20 },
          composition: {value: ''},
          connection: {value:"", type:"es-connection"},
          active: {value: true}
        },
        button: {
            toggle: "active",
            onclick: function(a,b) { 
                var label = RED.utils.sanitize(this.name||"es tail");
                var node = this;
                activateAjaxCall(node, node.active, function(resp, textStatus, xhr) {
                    var historyEvent = {
                        t:'edit',
                        node:node,
                        changes:{
                            active:!node.active
                        },
                        dirty:node.dirty,
                        changed:node.changed,
                        callback: function(ev) {
                            activateAjaxCall(ev.node, ev.node.active);
                        }
                    };
                    node.changed = true;
                    node.dirty = true;
                    RED.nodes.dirty(true);
                    RED.history.push(historyEvent);
                    RED.view.redraw();
                    if (xhr.status == 200) {
                        RED.notify(node._("es-tail.feed.activated",{label:label}),{type: "success", timeout: 2000});
                    } else if (xhr.status == 201) {
                        RED.notify(node._("es-tail.feed.deactivated",{label:label}),{type: "success", timeout: 2000});
                    }
                });
            }
        },
        color:'#C0DEED',
        paletteLabel: "tail",
        inputs:0,
        outputs:2,
        outputLabels: ["output", "status"],
        icon: 'elasticsearch.png',
        label: function() {
          return this.name || 'tail index';
        }
    });
})();
</script>

<script type="text/x-red" data-template-name="es-tail">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-index"><i class="icon-book"></i> Index</label>
        <input type="text" id="node-input-index" />
    </div>
    <div class="form-row">
        <label for="node-input-timeField"><i class="icon-book"></i> Time field</label>
        <input type="text" id="node-input-timeField" />
    </div>
    <div class="form-row">
        <label for="node-input-interval"><i class="icon-book"></i> Interval</label>
        <input type="text" id="node-input-interval" />
    </div>
        <div class="form-row">
        <label for="node-input-lookback"><i class="icon-book"></i> Lookback</label>
        <input type="text" id="node-input-lookback" />
    </div>
    <div class="form-row">
        <label for="node-input-composition"><i class="fa fa-bars"></i> Composition</label>
        <input type="text" id="node-input-composition" placeholder="Comma-sep. list of fields, leave blank for all" />
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-plug"></i> Connection</label>
        <input type="text" id="node-input-connection" />
    </div>
</script>

<script type="text/x-red" data-help-name="es-tail">
    <p>Tail an index and emit new documents.</p>
    <p>All indices matching the given index (pattern) need to have the specified time field.<br/>
    The default time field is @timestamp, however if you have <a href="https://www.elastic.co/guide/en/ecs/current/ecs-event.html#field-event-ingested"><i>event.ingested</i></a> then that would be a much better option<p>
    <p>This tail works by performing a scroll search at every <i>interval</i> seconds, fetching all docs from <i>now - interval - lookback</i> until </i<now</i>. Already seen (duplicate) events are skipped. The <i>lookback</i> is needed to cover scheduling gaps. The default is an interval of every 3 min. with a 20 sec. lookback</p>
    <p>Emitted fields on the "output" output<ul>
        <li>esDocId - The ES document ID
        <li>esIndex - The ES index name
        <li>esDocVer - The ES document version, if never modified it would be '1'
        <li>payload - The ES document content (_source)
    </ul></p>
    <p>There is also a "status" output that can be sued to react to status changes of the node itself</p>
</script>
